const AdEventTracker={adParams:{},__observerInitialized:!1,startedWidgets:new Set,completedWidgets:new Set,eventTypeToUrlMap:new Map,totalWidgets:0,hasAdCompleted:!1,configure({eventTypeToUrlMap:e}={}){e instanceof Map?this.eventTypeToUrlMap=e:"object"==typeof e&&(this.eventTypeToUrlMap=new Map(Object.entries(e)))},FireTracker(e="",t={}){if(!e)return;let r=Object.entries({...this.adParams,...t}).reduce((e,[t,r])=>(null!=r&&""!==r&&(e[t]=r),e),{}),i=new URLSearchParams(r).toString(),d=i?`${e}&${i}`:e;try{fetch(d,{method:"GET"}).catch(e=>{this.ErrorLogger.log("Tracking Fetch",`Exception: ${e.message||e}`)})}catch(s){this.ErrorLogger.log("Tracking Beacon",`Exception: ${s.message||s}`)}},ErrorLogger:{log(e,t){let r={widget:e,message:t?.message||t};console.log("[ERROR]",r),VservAdlabs?.notifyRenderer?.(VservAdlabsEvents?.ERROR,r)}},AdRender(){console.log("[AdRender] fired"),VservAdlabs?.notifyRenderer?.(VservAdlabsEvents?.RENDER,{})},AdClose(){console.log("[AdClose] fired"),VservAdlabs?.notifyRenderer?.(VservAdlabsEvents?.CLOSEABLE,{canClose:!0})},FireImpression(){console.log("[FireImpression] fired"),this.FireTracker(this.eventTypeToUrlMap.get("impression"))},TrackingHelper:{firedEvents:new Map,hasEngagementFired:!1,triggerEvent({widgetName:e="",eventName:t="",widgetId:r="",adWidgetId:i="",cumulative:d=!1,click:s=!1,engagement:a=!1}){if(!d){this.firedEvents.has(i)||this.firedEvents.set(i,new Set);let n=this.firedEvents.get(i);if(n.has(t))return;n.add(t)}let o={widget_id:r,ad_widget_id:i,event_name:t};if(a&&!this.hasEngagementFired){this.hasEngagementFired=!0;let l={...o,engagement_sum:1};console.log(`[ENGAGEMENT] Fired by "${e}"`,l),AdEventTracker.FireTracker(AdEventTracker.eventTypeToUrlMap.get("event"),l)}else s||(console.log(`[EVENT] Fired by "${e}"`,o),AdEventTracker.FireTracker(AdEventTracker.eventTypeToUrlMap.get("event"),o));s&&(VservAdlabs?.notifyRenderer?.(VservAdlabsEvents?.CLICK,o),console.log(`[CLICK] Fired by "${e}"`,o),AdEventTracker.FireTracker(AdEventTracker.eventTypeToUrlMap.get("click"),o))}},PauseWidgets(){this._getWidgets().forEach(e=>e.pause?.())},ResumeWidgets(){this._getWidgets().forEach(e=>e.resume?.())},PlayWidgets(){this._getWidgets().forEach(e=>e.play?.())},DestroyWidgets(){let e=document.querySelector("ad-frame-deck");if(e)for(this._getWidgets().forEach(e=>e.destroy?.());e.firstChild;)e.removeChild(e.firstChild)},_getWidgets(){let e=document.querySelector("ad-frame-deck");return e?Array.from(e.querySelectorAll("*")).filter(e=>e.tagName.startsWith("WGT-")&&("function"==typeof e.play||"function"==typeof e.pause||"function"==typeof e.resume||"function"==typeof e.destroy)):[]},InitVisibilityObserver(){if(this.__observerInitialized)return;let e=document.querySelector("ad-frame-deck");if(!e)return;let t=!1,r=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(this.__observerInitialized=!0,t=!0,"visible"===document.visibilityState&&(this.PlayWidgets(),window.dispatchEvent(new Event("ad-visible")))):(t=!1,this.PauseWidgets())})},{threshold:[.25]});r.observe(e),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?this.PauseWidgets():"visible"===document.visibilityState&&t&&this.ResumeWidgets()})},SetupListeners(){VservAdlabs?.addEventListener?.(VservAdlabsEvents?.PAUSE,()=>this.PauseWidgets()),VservAdlabs?.addEventListener?.(VservAdlabsEvents?.RESUME,()=>this.ResumeWidgets()),VservAdlabs?.addEventListener?.(VservAdlabsEvents?.CLOSE,()=>this.DestroyWidgets()),VservAdlabs?.addEventListener?.(VservAdlabsEvents?.AD_PARAMS_SET,(e={})=>{console.log("Received ad parameters:",e),this.adParams={...e}});let e=VservAdlabs?.getAdParams?.();0===Object.keys(this.adParams).length&&e&&Object.keys(e).length&&(console.log("Received ad parameters (via fallback):",e),this.adParams={...e}),this.InitVisibilityObserver()}};window.addEventListener("DOMContentLoaded",()=>{window.AdEventTracker=AdEventTracker,AdEventTracker.SetupListeners(),window.addEventListener("ad-visible",()=>AdEventTracker.FireImpression(),{once:!0}),window.addEventListener("ad-render",()=>AdEventTracker.AdRender(),{once:!0}),window.addEventListener("ad-completed",()=>AdEventTracker.AdClose(),{once:!0}),function e(){let t=document.querySelector("ad-frames-container");if(!t)return console.warn("No <ad-frames-container> found");let r=t.querySelector("ad-frame-deck");if(!r)return console.warn("No <ad-frame-deck> found inside container");let i=Array.from(r.querySelectorAll(":scope > *")).filter(e=>e.tagName.startsWith("WGT-")),d=new Set;function s(){d.size===i.length&&(console.log("All widgets in first <ad-frame-deck> are rendered"),window.dispatchEvent(new Event("ad-render")),AdEventTracker.totalWidgets=i.length,i.forEach(e=>{(function e(t){let r=()=>{AdEventTracker.startedWidgets.has(t)||(AdEventTracker.startedWidgets.add(t),console.log(`[WidgetStarted] ${t.tagName.toLowerCase()} started (${AdEventTracker.startedWidgets.size}/${AdEventTracker.totalWidgets})`),VservAdlabs?.notifyRenderer?.(VservAdlabsEvents?.CLOSEABLE,{canClose:!1}))};t.isStarted?r():(t.addEventListener("wgt-started",r,{once:!0}),setTimeout(()=>{t.isStarted&&r()},50))})(e),e.isCompleted?AdEventTracker.completedWidgets.add(e):e.addEventListener("wgt-completed",()=>{AdEventTracker.completedWidgets.add(e),console.log(AdEventTracker.totalWidgets),AdEventTracker.hasAdCompleted||AdEventTracker.completedWidgets.size!==AdEventTracker.totalWidgets||(AdEventTracker.hasAdCompleted=!0,console.log("[AdComplete] All widgets completed"),window.dispatchEvent(new Event("ad-completed")))},{once:!0})}))}i.forEach(e=>{e.isRendered?d.add(e):e.addEventListener("wgt-rendered",()=>{d.add(e),s()},{once:!0})}),s()}()});